# Лекция 1 (13.09.24)

Ссылочная целостность данных (Referential Integrity)

Flat-file database (.csv, for search and update DBMS read whole file)
Issues:
- Expandability, compatibility
- Data integrity
- Durability
- Transactions
- Efficient search and data modifications

DBMS is software that allows applications to store and analyze information in a DB.
General-purpose DBMS supports the definition, creation, querying, update and administration of DBs in accordance with some _data model_.

Data model - collection of concepts for describing data in a DB.
Examples:
- Relational
- NoSQL (Key/Value, Hierarchical Graph, Document/XML/Object)
- Array/Matrix/Vector (ML)
Schema - description of a particular collection of data, using a given data model.

SQL -> NoSQL -> NewSQL/DistributedSQL

Databases by type of load:
- OLAP - Online Analytical Processing
- OLTP - Online Transactional Processing
- HTAP - Hybrid Transactional/Analytical Processing

ACID properties:
- Atomicity
- Consistency
- Isolation
- Durability

Isolation level and read phenomena:

| Level            |     |     |     | Phantom read |
| ---------------- | --- | --- | --- | ------------ |
| Read uncommitted |     |     |     |              |
| Read committed   |     |     |     |              |
| Repeatable read  |     |     |     |              |
| Snapshot         |     |     |     |              |
| Serializable     |     |     |     |              |

Logical level - the level of entities, their connections and attributes.
Physical level - the level of data storage on the disk.

## Relational data model

Relational data model aspects:
- Structural
- Integrity
- Manipulation

Relation - unordered set of relationships of attributes that represent entities.
Tuple - set of attributes in a relation.
Attribute - name associated with a domain (data type).

n-ary relation - relation with n columns.

Primary key - uniquely identifies a tuple in a relation.
Foreign key 

Constraints:
- Referential
- Unique key
- Predicate

## Relational algebra

Operators:
- Select
- Projection
- Union
- Intersection
- Difference
- Product
- Join

Additional:
- Rename
- Aggregation
- Sorting
- Duplicate elimination
- Assignment
- Division
# Семинар 1

Minimum language syntax: SQL-92
2016 - JSON support
2019-2020  - Multidimensional arrays
2023 - Property Graph Queries

DDL
DML

`explain ...`

Filters: `where`

Pagination:
- `offset + limit` - bad idea
- `where + order by + limit`

`having` - как `where`, но после `group by`

Window functions:
`... over (partition by ...)`

Joins:
`cross join`, `inner join`, `left join`, `left semi join`, `left anti join`
`lateral`

Cte:
`with t(c,...) as (...)`
`with recursive`
# Лекция 2 - Storage 1 - (20.09.24)

Disk-oriented DB architecture
## Storage Hierarchy

faster, smaller, expensive
volatile, random access byte-addressable
- Devices closest to the CPU (registers, etc.)
- CPU caches L1, L2, L3
- DRAM

non-volatile sequential-access block-addressable
- SSD
- HDD
- Network Storage
slower, larger, cheaper
## Storage latency

1. 0.5ns L1 cache reference
2. 7ns L2 cache reference
3. 100ns DRAM (can be more when access to different NUMA node)
4. 150.000ns SSD
5. 10.000.000ns HDD
6. ~30.000.000ns Network Storage

SATA SSD ~600 MB/s
NVME SSD ~3.5GB/s
## DBMS Storage Components

Manage the movement of data between non-volatile and volatile memory.
The system cannot work with data directly on disk without first moving it to volatile storage.

`mmap`

`madvice` - tells OS the subsequent page reading strategy
`mlock` - tells OS that a range of pages cannot be swapped out of memory
`msync` - tells OS to synchronize a range of pages (write to disk)

OS cannot effectively understand which pages need to be flushed on disk, and which should be kept in memory for subsequent access.

A DBMS can do this more efficiently:
1. The correct order for flushing pages to disk
2. Preloading data (prefetch)
3. Resource IO scheduling
4. Cache policy is difficult to manage

[Are You Sure You Want to Use MMAP in Your Database Management System? (cidrdb.org)](https://www.cidrdb.org/cidr2022/papers/p13-crotty.pdf)
## File Storage

The DBMS stores the DB in the form of one or more files on disk
## Storage Manager

Responsible for storing DB files

1. Organize files as a set of pages
2. Tracking reading/writing data to pages
3. Monitoring of available space
4. May be responsible for scheduling reads and writes, improve data locality on pages

DBMS Page - block of data of a fixed size (usually 512B - 16KB).
Page can contain tuples, metadata, indexes, WAL records.
Each page is assigned a unique identifier.
The DBMS uses an indirect layer to map page identifiers to their physical location on disk.
## Page Storage Architecture
### Heap File

Heap file - an unordered set of pages where tuples are stored in random order.
- Linked List
	Header page at the beginning of the file, which stores HEADs of the list of free pages and pages filled with data. Each page itself tracks the number of free slots.
- Page Directory
	

![[(img) DBMS Page Storage Linked List.png]]![[(img) DBMS Page Storage Page Directory.png]]

### Page Layout

Header with metadata:
- Page size
- Checksum
- DBMS version
- Transaction visibility
- Compression information

| Header |
| :----: |
|  Data  |
### Tuple Storage

1. Tuples are stored one after another, header stores number of tuples.
	Problem: after deleting tuple we have to move the ones after the tuple
2. Slotted pages

![[(img) DBMS Page Storage Slotted Pages.png]]
### Tuple Layout

A sequence of bytes, DBMS task is to interpret it.

Has a header with metadata:
- Transaction visibility metadata
- Bit mask for null values

Each tuple is assigned a unique record ID. Usually this is `page_id` + offset/slot. May also contain info about the location of the file.

Postgres: `table.ctid`
### Data Types

- Integers (INTEGER, BIGINT, SMALLINT, TINYINT)
- Variable Precision Numbers (FLOAT, DOUBLE/REAL)
- Fixed Precision Numbers (NUMERIC, DECIMAL)
- Fixed Length Data - fixed length byte array (CHAR)
- Variable Length Data - byte array of arbitrary length (VARCHAR, VARBINARY, TEXT)
- External Value Data - tuple as an external file (BLOB)
- Dates and Times (TIME, DATE, TIMESTAMP)
- Additional Types (ENUM, Arrays, Geometric types, Composite Types, JSON/XML, Range)

Most DBMSs do not allow a tuple to be larger than one page. They solve this problem by moving value to the overflow page, and place in the tuple a pointer to the value on overflow page.

Postgres: TOAST (>1/4 page size)
MySQL: Overflow (>1/2 page size)
## System Catalog

The DBMS stores metadata about DBs in its system directories.

1. Tables, Views, Columns, Attributes, Indexes
2. Users, Access rights

Most DBMSs store metadata in special system tables.
# Семинар 2 - Postgres Storage

Books: "PostgreSQL 16 Изнутри"